---
layout: post
title: Requiring Login to CakePHP Admin
date: '2009-07-09T12:29:00-04:00'
tags:
- php
- cakephp
- bestof
tumblr_url: https://seanmonstar.com/post/707166936/requiring-login-to-cakephp-admin
---
<p>For some of my freelance clients, I have provided a home-brewed CMS, built using CakePHP, since I&rsquo;d already used Cake for the rest of their web-site. I wanted to create a couple users, and an interface to be able to create pages that made up the navigation and content.</p>
<p>Building an admin area for this functionality, the first thing I did was turn on <a target="_blank" href="http://book.cakephp.org/view/46/Routes-Configuration#Prefix-Routing-544">admin routing</a>.</p>
<p>Since we&rsquo;re logging in Users, we build a <code>User</code> model and <code>UsersController</code>. In the User model, write whatever extra you need, but the basics is just a validation function, to match username with password when logging in.</p>
<pre><code>function validateLogin($data) {    
	$user = $this-&gt;find(array(        
			'username' =&gt; $data['username'],        
			'password' =&gt; md5($data['password'])        
		), array('id', 'username'));        
	return !empty($user) ? $user['User'] : false;      
}</code></pre>
<p>You can add any additional validation rules in here, and you might want to use a <a href="http://mcarthurgfx.com/blog/article/a-basic-lesson-in-password-hashing">better hashing use than simpy straight md5</a>. Anyhow, this function will be called from the <code>UsersController</code>. So let&rsquo;s dive into there.</p>
<h4>UsersController</h4>
<p>Throw together a simple login function. I&rsquo;ll let your imagination put together the view, that&rsquo;s just some simple html form stuff. Check for post data, validate with the above function, write the User object to the session and redirect to the admin area.</p>
<p>And conversely, logging out is simply destroying the User object from the session and redirecting out of the admin area. Simple stuff.</p>
<p>To help <em>enforce</em>logging in though, we pay attention to the filter event of controllers, and check the session first. The <a target="_blank" href="http://book.cakephp.org/view/60/Callbacks">process of a controller</a> responding to the router is <em>beforeFilter -&gt; <strong>action</strong> -&gt; beforeRender -&gt; render -&gt; afterFilter</em>. You can make sure things happen before it calls any action, by writing a beforeFilter method. You could use this method to check for things, and if it&rsquo;s not up to snuff, redirect to a different page. That&rsquo;s what we&rsquo;re going to do.</p>
<p>So, in the UsersController, we want to make sure that a user can&rsquo;t do anything pertaining to users until they login.</p>
<pre><code>function beforeFilter() {    
	if($this-&gt;action != 'login' &amp;&amp; $this-&gt;action != 'logout') {        
		if($this-&gt;Session-&gt;check('User') == false) {            
			$this-&gt;redirect('login');           
			$this-&gt;Session-&gt;setFlash('The URL you\\'ve followed requires you login.');        
		}    
	}
}</code></pre>
<h4>Admin Requires Login</h4>
<p>The last step is ensuring that any time a user wants to access the admin part of our app, they must be a logged in user, or they the boot. This involves using the same event as above, but in the <code>AppController</code>. The <code>AppController</code> lets us write something that should happen in every controller, because by default we should be extending <code>AppController</code>.</p>
<p>However, we don&rsquo;t want it to <strong>always</strong>be forcing logins. Visitors who access public areas shouldn&rsquo;t have to login. But if they want to access the admin areas, <strong>that&rsquo;s</strong> when we want to force them.</p>
<p>With our admin routing turned on, any time the Router wants to invoke a method because of the <code>Routing.admin</code> configuration, it will add to the <code>params</code> of the controller <code>'admin' = 1</code>. Thus, we can easily make our filter only care if admin is set.</p>
<pre><code>class AppController extends Controller {     
	function beforeFilter() {
        if ($this-&gt;params['admin']) {
            if($this-&gt;Session-&gt;check('User') == false) {
                $this-&gt;flash("The URL you\'ve followed requires you login.",'/login',2);
            }
            $this-&gt;layout = 'admin';
        }
    } 
}</code></pre>
<h4>Admin Galore</h4>
<p>Now, any page we want to setup as requiring admin access, like in my CMS, allowing admins to edit pages, we create functions prepended with value in your config for <code>Routing.admin</code>. By default, that&rsquo;s <code>admin</code>.</p>
<p>This simple addition now requires you be logged in (with a user made either manually by myself or using a registration form you can build into the <code>UsersController</code>) in order to see the list of pages.</p>
<pre><code>class PagesController extends AppController {    
	function admin_index() {        
		//setting the layout could be done in        
		//the AppController beforeFilter, so all        
		//admin pages use the admin layout instead.        
		$this-&gt;layout = 'admin';                
		$this-&gt;set('pages',$this-&gt;Page-&gt;getNav());
	}   
}</code></pre>
<p>The default view for this follows the same kind of automagic rules for CakePHP: it&rsquo;ll be <code>app/views/pages/admin_index.ctp</code>.</p>
