---
layout: post
title: Fixing HTML5 Loaded Via Ajax in IE
date: '2010-06-30T11:24:18-07:00'
tags:
- html5
- javascript
- mootools
tumblr_url: http://seanmonstar.com/post/754502783/fixing-html5-loaded-via-ajax-in-ie
---
<p>Internet Explorer doesn&rsquo;t support HTML5 elements. You must provide a <a href="http://www.google.com/search?q=ie+html5+shim">shim</a>. But this only helps fix any markup that is in the original document. If you receive more markup via an ajax request, and want to insert it into the document, IE has a hissy fit. You can&rsquo;t stick HTML like that into some elements <code>innerHTML</code> property and hope it parses correctly.</p>

<p>What I did instead, was before inserting the HTML, I&rsquo;d find all HTML5 elements<sup id="fnref:p754502783-1"><a href="#fn:p754502783-1" rel="footnote">1</a></sup>, convert them to spans with an extra attribute <code>htmlfix</code> with the value set to the tag name it should be. Then after inserting into an <code>innerHTML</code>, I&rsquo;d find all the spans with an <code>htmlfix</code> attribute, create the proper element, transfer all its <code>attributes</code>, set its <code>innerHTML</code>, and <code>replaceNode</code>.<sup id="fnref:p754502783-2"><a href="#fn:p754502783-2" rel="footnote">2</a></sup></p>

<pre><code>function processAjax(content) {
    var spanned = content,
        html5els = ['nav','header','article','footer','section','time'], //etc...
        attributes = ['id', 'class', 'pubdate', 'datetime']; //etc...

    html5els.forEach(function(tag) {
        var re = new RegExp('&lt;(\/?)'+tag+'([^&gt;]*)&gt;', 'g');
        spanned = spanned.replace(re, '&lt;$1span htmlfix="'+tag+'"$2&gt;');
    });
    var el = new Element('div', { html: spanned }).getFirst();

    //after IE parses the spans, createElements of all the "fixed" elements
    el.getElements('span[htmlfix]').forEach(function(span) {

        var tagname = span.get('htmlfix');
        span.erase('htmlfix');

        var newEl = new Element(tagname, { html: span.innerHTML });

        //transfer attributes
        attributes.forEach(function(attr) {
            var val = span.get(attr);
            if(val) {
                newEl.set(attr, val);
            }
        });

        newEl.replaces(span);
    });

    return el;
}
</code></pre>

<div class="footnotes">
<hr><ol><li id="fn:p754502783-1">
<p>Yes, I used <a href="http://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454">Regex to parse HTML</a>. No, it didn&rsquo;t create a rift in space. <a href="http://www.codinghorror.com/blog/2009/11/parsing-html-the-cthulhu-way.html">I knew what I was doing</a>. <a href="#fnref:p754502783-1" rev="footnote">↩</a></p>
</li>

<li id="fn:p754502783-2">
<p>This uses <a href="http://www.mootools.net">MooTools</a>, because it&rsquo;s awesome. I wasn&rsquo;t feeling very masochistic this time around, so I didn&rsquo;t create a vanilla JS version. <a href="#fnref:p754502783-2" rev="footnote">↩</a></p>
</li>

</ol></div>
