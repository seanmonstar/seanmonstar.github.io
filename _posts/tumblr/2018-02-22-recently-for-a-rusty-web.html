---
layout: post
title: Recently, for a Rusty Web
date: '2018-02-22T13:51:14-05:00'
tags:
- rust
- rust-lang
- hyper
- buoyant
tumblr_url: https://seanmonstar.com/post/171170905822/recently-for-a-rusty-web
---
<p>It&rsquo;s been a few months since <a href="http://seanmonstar.com/2023/2017-09-01-bye-mozilla-hello-buoyant/">I shifted my focus</a> full time to Rust, and in that time, we&rsquo;ve gotten a lot of work done! I wanted to update you here what all that is, since it&rsquo;s spread around on multiple repositories.</p>

<h2>The <code>http</code> crate</h2>

<p>We <a href="https://users.rust-lang.org/t/announcing-the-http-crate/12123">started working</a> on the <a href="https://crates.io/crates/http">http</a> crate earlier last year, but in September, we released <a href="https://crates.io/crates/http">v0.1</a>! The point of this crate was pull out the &ldquo;HTTP primitives&rdquo;, like headers, methods, status codes, and the like, and put them into a base crate. The hope is that HTTP implementations can expose APIs using these types, and web frameworks can expect them, and thus more easily change implementations if so desired.</p>

<p>Since then, we&rsquo;ve seen several implementations already put them to good use:</p>

<ul>
<li><a href="https://crates.io/crates/h2">h2</a></li>
<li><a href="https://crates.io/crates/actix-web">actix-web</a></li>
<li><a href="https://crates.io/crates/simple-server">simple-server</a></li>
</ul>

<h2>The <code>h2</code> crate</h2>

<p>At <a href="https://buoyant.io">Buoyant</a>, one of the products we build is <a href="https://conduit.io">Conduit</a>, a service-mesh slash proxy built for Kubernetes environments, requiring minimal setup. The proxy part (&ldquo;data plane&rdquo;) is built in Rust. Since many internal services take advantage of HTTP2, we needed a working HTTP2 implementation in Rust. So, we built one! After building and using it in Conduit, we eventually got it to a <a href="https://crates.io/crates/h2">v0.1 release of h2</a>.</p>

<p>Importantly, it&rsquo;s fast, implements the full HTTP2 specification, and works with asynchronous IO and futures.</p>

<h2>Tower and gRPC</h2>

<p>Besides an HTTP2 implementation, we also needed use <a href="https://grpc.io">gRPC</a> to have the proxy talk with the controller. We built up a middleware suite, <a href="https://github.com/tower-rs/tower">tower</a>, which needs its own announcement when it&rsquo;s released, but in short, is an evolution of <a href="https://crates.io/crates/tokio-service">tokio-service</a>, sort of like finagle for Rust. Once we had several <code>Service</code>s working, we got to work on <a href="https://github.com/tower-rs/tower-grpc">tower-grpc</a>, which merges together tower, the h2 crate, and protobuf to get elegant code generation speaking gRPC.</p>

<h2>hyper</h2>

<p>Besides all those awesome things, the <a href="https://hyper.rs">hyper</a> crate has continued to see increased development. Since September, hyper has seen 16 point releases, bringing bug fixes, performance improvements, and new features! Some highlights:</p>

<ul>
<li><strong>hyper got even faster.</strong> Besides bug fixes and new features, hyper managed to get even faster than before, as shown in these <a href="https://www.techempower.com/benchmarks/#section=data-r15&amp;hw=ph&amp;test=plaintext">benchmarks</a>. Admittedly, microbenchmarks need to be considered with plenty of salt, but it ain&rsquo;t nothing! Besides the microbenchmark, hyper also improvement throughput for bigger streaming bodies by intelligently using <code>writev</code> when it can (it also detects if <code>writev</code> isn&rsquo;t helping, and reverts to previous behavior).</li>
<li><p><strong>Added APIs to create servers with a shared tokio <code>Core</code></strong>. The easy entry point to running a server in hyper is using <code>Http::bind</code>, which creates a <code>Server</code> with its own <code>Core</code>. However, as applications get more complex, you may want to use the same <code>Core</code> for multiple things. Several APIs were added to allow doing just that: <code>Http::serve_addr_handle</code>, <code>Http::serve_incoming</code>, and <code>Http::serve_connection</code>.</p>

<p>Even better news is that with the <a href="https://tokio.rs/blog/2018-02-tokio-reform-shipped/">new design of tokio</a>, using both these lower level APIs and the higher level <code>Server</code> will be much easier, by having assumed default reactors, while allowing you set a specific one if so desired. Things should be getting much easier real soon!</p></li>
<li><strong>Removed dependence on tokio-proto.</strong> The <code>tokio-proto</code> crate was initially used internally, but it hasn&rsquo;t seen many updates, and it was found to be buggy. hyper was suffering from those bugs, as well as not being able to improve the exposed API. A bunch of work was done to build an internal dispatcher, removing the need to rely on tokio-proto, and fixing a bunch of bugs in the process.</li>
<li><strong>Added compatibility with the <code>http</code> crate.</strong> Completely switching the HTTP types to those from the <code>http</code> crate is a breaking change, but to allow usage incrementally, you can opt-in to using them by enabling the Cargo <code>compat</code> feature of hyper. In 0.12, they will be completely replaced.</li>
</ul>

<h2>Coming soon</h2>

<p>With all the work happening to release <a href="https://github.com/rust-lang-nursery/futures-rfcs/blob/master/futures-02.md">futures 0.2</a>, the <a href="https://tokio.rs/blog/2018-02-tokio-reform-shipped/">tokio reform</a>, the <a href="https://crates.io/crates/http">http crate</a>, and the <a href="https://crates.io/crates/h2">h2 crate</a>, there are some changes coming to hyper. See the <a href="https://github.com/hyperium/hyper/milestone/4">0.12 milestone</a> if you want to follow along!</p>
